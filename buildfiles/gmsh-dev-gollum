# vim: set ft=sh:
pkgname=gmsh
pkgver=dev
destdir=$REPO/opt/$pkgname-$pkgver
srcdir=gmsh

export USE_CMAKE=1
export MAKE_NUMJOBS=8

module load opencascade
module load slepc-py2

confopts=$(cat <<END_HEREDOC
-D CMAKE_INSTALL_PREFIX:PATH=$destdir
-D GMSH_BIN:PATH=$destdir/bin
-D GMSH_LIB:PATH=$destdir/lib
-D GMSH_DOC:PATH=$destdir/doc
-D GMSH_MAN:PATH=$destdir/man
-D ENABLE_NATIVE_FILE_CHOOSER:BOOL=ON
-D ENABLE_BUILD_LIB:BOOL=ON
-D ENABLE_BUILD_SHARED:BOOL=ON
-D ENABLE_FLTK:BOOL=ON
-D ENABLE_MPI:BOOL=ON
-Wno-dev
END_HEREDOC
)

prepare()
{
  [[ -d $destdir ]] && rm -rf $destdir
  [[ -d $tmpdir ]] && rm -rf $tmpdir
  mkdir -pv $tmpdir
  pushd $tmpdir
  if [[ -d gmsh ]]; then
    pushd gmsh
    svn update
    popd
  else
    svn co https://onelab.info/svn/gmsh/trunk gmsh
  fi
  #pushd gmsh
  #patch -Np0 < $REPO/buildfiles/gmsh_petsc_dev.diff
  #popd
  popd
}

pkgmodule=$(cat <<END_HEREDOC
#%Module
module load opencascade slepc-py2

set GMSH_DIR $destdir
setenv GMSH_DIR \$GMSH_DIR

prepend-path PATH \$GMSH_DIR/bin
END_HEREDOC
)

