# vim: filetype=sh
pkgname=vtk
pkgver=6.3.0
pkgurl=http://www.vtk.org/files/release/${pkgver:0:3}/VTK-${pkgver}.tar.gz
srcdir=VTK-$pkgver
destdir=$REPO/opt/$pkgname-$pkgver

export USE_CMAKE=1
module load freetype libxml2 libpng
module load python scipy matplotlib mpi4py
module load openmpi hdf5 netcdf netcdf-cxx
module load cmake
module load boost

export CXX=mpic++
export CC=mpicc
export HDF5_ROOT=$HDF5_DIR

confopts=$(cat <<-EOT
-D CMAKE_BUILD_TYPE:STRING=Release
-D BUILD_SHARED_LIBS:BOOL=ON
-D VTK_Group_Imaging:BOOL=ON
-D VTK_Group_MPI:BOOL=ON
-D VTK_Group_Views:BOOL=ON
-D VTK_Group_Qt:BOOL=OFF
-D Module_vtkRenderingParallel:BOOL=ON
-D Module_vtkInfovisBoost:BOOL=ON
-D Module_vtkInfovisBoostGraphAlgorithms:BOOL=ON
-D Module_vtkRenderingFreeTypeFontConfig:BOOL=ON
-D Module_vtkRenderingMatplotlib:BOOL=ON
-D VTK_USE_SYSTEM_PNG:BOOL=ON
-D VTK_USE_SYSTEM_ZLIB:BOOL=ON
-D VTK_USE_SYSTEM_HDF5:BOOL=ON
-D VTK_USE_SYSTEM_MPI4PY:BOOL=ON
-D VTK_USE_SYSTEM_NETCDF:BOOL=ON
-D VTK_USE_SYSTEM_FREETYPE:BOOL=ON
-D VTK_USE_SYSTEM_LIBXML2:BOOL=ON
-D VTK_RENDERING_BACKEND:STRING=OpenGL2
-D NETCDF_CXX_ROOT:PATH=$NETCDFCXX_DIR
-D VTK_USE_COCOA:BOOL=ON
-D BUILD_EXAMPLES:BOOL=OFF
-D BUILD_TESTING:BOOL=OFF
-D VTK_WRAP_PYTHON:BOOL=ON
-D VTK_LEGACY_REMOVE:BOOL=ON
-D PYTHON_LIBRARY:PATH=`python-config --prefix`/lib/libpython2.7.dylib
-D PYTHON_INCLUDE_DIR:PATH=`python-config --prefix`/include/python2.7
-D CMAKE_SKIP_INSTALL_RPATH:BOOL=OFF
-D CMAKE_SKIP_BUILD_RPATH:BOOL=OFF
-D CMAKE_INSTALL_NAME_DIR:PATH=$destdir/lib
EOT)

build()
{
  pushd $builddir
  make -j8
  popd
}

pkgmodule=$(cat <<-EOT
#%Module
module load python
module load mpi4py
module load matplotlib

set VTK_DIR $REPO/opt/vtk-$pkgver
setenv VTK_DIR \$VTK_DIR

prepend-path PATH \$VTK_DIR/bin
prepend-path PYTHONPATH \$VTK_DIR/lib/python2.7/site-packages
EOT)
